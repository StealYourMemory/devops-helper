import{t as se}from"./time-DxmJvrj7.js";import{a as F}from"./axios-CEz4Hwn_.js";import{d as ue}from"./debounce-BzScJiEs.js";import{d as de,j as v,s as L,E as P,x as D,o as V,c as z,f as e,w as a,F as S,r,m as H,I as ie,T as pe,n as y,t as M,q as ce,l as O,O as me,A as j,g as G,p as ve,h as fe,a as f,_ as ge}from"./index-B8KVQuq1.js";import{a as _e}from"./projectApi-DNyIEPDE.js";import{s as be}from"./sleeep-DLQXQLPT.js";const T="/k8s";async function ye(i){return(await F.post(`${T}/proxy/query`,i)).data}async function xe(i){return(await F.post(`${T}/proxy`,i)).data}async function we(i){return(await F.delete(`${T}/proxy/${i}`)).data}const J=(i,d,c)=>{const m=/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;if(d)if(m.test(d))c();else return c(new Error("请输入正确的IPv4地址"));else return c(new Error("请输入ip"))},K=(i,d,c)=>{const m=Number(d);if(!d&&d!==0)return c(new Error("请输入端口"));if(isNaN(m)||m<1||m>65535||!Number.isInteger(m))return c(new Error("端口号必须在1到65535之间"));c()},Pe={envName:{required:!0,message:"请选择环境",trigger:"change"},proxyHost:{required:!0,validator:J,trigger:"change"},srcHost:{required:!0,validator:J,trigger:"change"},proxyPort:{required:!0,validator:K,trigger:"change"},srcPort:{required:!0,validator:K,trigger:"change"}},g=i=>(ve("data-v-7aa3ce25"),i=i(),fe(),i),Ve=g(()=>f("span",null,"创建代理",-1)),he=g(()=>f("br",null,null,-1)),Ne=g(()=>f("br",null,null,-1)),ke=g(()=>f("br",null,null,-1)),He=g(()=>f("strong",null,"代理服务器IP+代理端口",-1)),Ie=g(()=>f("br",null,null,-1)),Ue=g(()=>f("strong",null,"注：请保证代理端口在代理服务器上未被占用，如果代理不通，请确保代理服务器与源服务之间是通的",-1)),Ce=g(()=>f("br",null,null,-1)),ze=g(()=>f("strong",null,"注：用完的代理要及时删除！！！避免端口长期占用",-1)),Se=g(()=>f("br",null,null,-1)),Fe=de({__name:"ProxyPage",setup(i){const d=v(!1),c=v([]),m=v([]);L(async()=>{const o=await _e();o.success?(m.value=o.data,c.value=o.data.map(l=>({label:l.envDescription,value:l.envName,disabled:l.serverSet==null||l.serverSet.length==0}))):P.error(o.msg)});const p=v({envName:"",proxyHost:"",srcHost:""}),b=v({paging:!0,page:1,total:0,size:10});L(()=>{x()});async function Q(){d.value=!0,await be(500),await x(),d.value=!1,P.success("刷新成功")}const W=ue(x,300);D(p,W,{deep:!0});async function x(){const o=await ye({...p.value,...b.value});if(o.success){const{paging:l,page:u,size:s,total:w,records:I}=o.data;b.value={paging:l,page:u,size:s,total:w,records:I}}else P.error(o.msg)}function X(o){return m.value.find(u=>u.envName===o).envDescription}function Y(o){me.confirm("确认删除当前代理?",{confirmButtonText:"是",cancelButtonText:"取消",type:"warning"}).then(async()=>{const l=j.service({lock:!0,text:"Loading",background:"rgba(0, 0, 0, 0.7)"}),u=await we(o);l.close(),u.success?(await x(),P.success("删除成功")):P.error(u.msg)}).catch(()=>{})}const h=v(!1),n=v({envName:"",srcHost:"",proxyHost:""}),N=v(),Z=v(Pe);async function ee(o){o&&await o.validate(async(l,u)=>{if(l){const s=j.service({lock:!0,text:"Loading",background:"rgba(0, 0, 0, 0.7)"}),w=await xe(n.value);s.close(),w.success?(await x(),N.value.resetFields(),h.value=!1,P.success("添加成功")):P.error(w.msg)}else console.log("error submit!",u)})}const q=v([]);return D(()=>n.value.envName,()=>{if(n.value.envName){const o=m.value.find(l=>l.envName===n.value.envName);o!=null&&(q.value=o.serverSet.map(l=>({label:l.ip,value:l.ip}))),n.value.proxyHost=""}}),(o,l)=>{const u=r("el-input"),s=r("el-form-item"),w=r("el-date-picker"),I=r("el-space"),U=r("el-icon"),k=r("el-button"),B=r("el-form"),le=r("el-header"),_=r("el-table-column"),te=r("el-table"),E=r("el-main"),ae=r("el-pagination"),R=r("el-footer"),oe=r("el-tooltip"),$=r("el-option"),A=r("el-select"),ne=r("el-container"),re=r("el-dialog");return V(),z(S,null,[e(le,null,{default:a(()=>[e(B,{modelValue:p.value,"onUpdate:modelValue":l[5]||(l[5]=t=>p.value=t),inline:""},{default:a(()=>[e(s,{label:"源IP"},{default:a(()=>[e(u,{modelValue:p.value.srcHost,"onUpdate:modelValue":l[0]||(l[0]=t=>p.value.srcHost=t),clearable:""},null,8,["modelValue"])]),_:1}),e(s,{label:"代理IP"},{default:a(()=>[e(u,{modelValue:p.value.proxyHost,"onUpdate:modelValue":l[1]||(l[1]=t=>p.value.proxyHost=t),clearable:""},null,8,["modelValue"])]),_:1}),e(s,{label:"创建时间"},{default:a(()=>[e(I,null,{default:a(()=>[e(w,{modelValue:p.value.startTime,"onUpdate:modelValue":l[2]||(l[2]=t=>p.value.startTime=t),type:"datetime",placeholder:"开始","value-format":"x",clearable:""},null,8,["modelValue"]),e(w,{modelValue:p.value.endTime,"onUpdate:modelValue":l[3]||(l[3]=t=>p.value.endTime=t),type:"datetime",placeholder:"结束","value-format":"x",clearable:""},null,8,["modelValue"])]),_:1})]),_:1}),e(s,null,{default:a(()=>[e(k,{loading:d.value,onClick:Q},{default:a(()=>[e(U,null,{default:a(()=>[e(H(ie))]),_:1})]),_:1},8,["loading"])]),_:1}),e(s,null,{default:a(()=>[e(k,{type:"danger",onClick:l[4]||(l[4]=t=>h.value=!0)},{default:a(()=>[e(U,null,{default:a(()=>[e(H(pe))]),_:1}),Ve]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),e(E,{style:{"margin-top":"2%"}},{default:a(()=>[e(te,{data:b.value.records,stripe:"","max-height":"500"},{default:a(()=>[e(_,{type:"index",label:"#",width:"60px"}),e(_,{label:"环境",align:"center","header-align":"center",width:"120px"},{default:a(t=>[y(M(X(t.row.envName)),1)]),_:1}),e(_,{prop:"srcHost",label:"源IP",align:"center","header-align":"center"}),e(_,{prop:"srcPort",label:"源端口",width:"120",align:"center","header-align":"center"}),e(_,{prop:"proxyHost",label:"代理IP",align:"center","header-align":"center"}),e(_,{prop:"proxyPort",label:"代理端口",width:"120",align:"center","header-align":"center"}),e(_,{prop:"description",label:"用途",align:"center","header-align":"center"}),e(_,{label:"创建时间",align:"center","header-align":"center"},{default:a(t=>[y(M(t.row.createTime==null?"--":H(se)(t.row.createTime)),1)]),_:1}),e(_,{label:"删除",align:"center","header-align":"center",width:"200"},{default:a(t=>[e(k,{icon:"delete",type:"danger",size:"small",onClick:C=>Y(t.row.id)},null,8,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1}),e(R,null,{default:a(()=>[e(R,{class:"footer-right"},{default:a(()=>[e(ae,{"current-page":b.value.page,"onUpdate:currentPage":l[6]||(l[6]=t=>b.value.page=t),"page-size":b.value.size,"onUpdate:pageSize":l[7]||(l[7]=t=>b.value.size=t),"page-sizes":[10,20,50,100],layout:"total,prev, pager, next,sizes",total:b.value.total,onSizeChange:x,onCurrentChange:x},null,8,["current-page","page-size","total"])]),_:1})]),_:1}),e(re,{modelValue:h.value,"onUpdate:modelValue":l[15]||(l[15]=t=>h.value=t),title:"添加代理",width:"20%",onClose:l[16]||(l[16]=t=>{var C;return(C=N.value)==null?void 0:C.resetFields()})},{default:a(()=>[e(ne,null,{default:a(()=>[e(E,null,{default:a(()=>[e(oe,null,{content:a(()=>[y(" 使用k8s的service做代理，主要使用场景是k8s服务器可以访问通的服务，但本地办公网访问不通"),he,y(" 如我们在多出口联调的时候，创建的虚墙，k8s服务器可以连上，但本地无法连接，有时本地调试比部署到服务器方便些，就可以将这个虚墙代理出来"),Ne,y(" 源IP和源端口是为了要代理服务的IP和端口，如虚墙IP+830端口，代理服务器是某个环境的k8s服务器，代理端口是代理出的端口"),ke,y(" 一旦创建代理成功，就可以使用"),He,y("来访问要代理的服务"),Ie,Ue,Ce,ze,Se]),default:a(()=>[e(U,{size:"large"},{default:a(()=>[e(H(ce))]),_:1})]),_:1}),e(B,{"label-width":"120px",model:n.value,rules:Z.value,ref_key:"ruleFormRef",ref:N},{default:a(()=>[e(s,{label:"环境",prop:"envName"},{default:a(()=>[e(A,{modelValue:n.value.envName,"onUpdate:modelValue":l[8]||(l[8]=t=>n.value.envName=t),filterable:"",clearable:"",placeholder:"请选择环境",style:{width:"200px"}},{default:a(()=>[(V(!0),z(S,null,O(c.value,t=>(V(),G($,{key:t.label,value:t.value,label:t.label,disabled:t.disabled},null,8,["value","label","disabled"]))),128))]),_:1},8,["modelValue"])]),_:1}),e(s,{label:"源IP：",prop:"srcHost"},{default:a(()=>[e(u,{style:{width:"200px"},modelValue:n.value.srcHost,"onUpdate:modelValue":l[9]||(l[9]=t=>n.value.srcHost=t),clearable:"",placeholder:"输入要代理的IP"},null,8,["modelValue"])]),_:1}),e(s,{label:"源端口：",prop:"srcPort"},{default:a(()=>[e(u,{style:{width:"200px"},modelValue:n.value.srcPort,"onUpdate:modelValue":l[10]||(l[10]=t=>n.value.srcPort=t),clearable:"",placeholder:"输入要代理的端口"},null,8,["modelValue"])]),_:1}),e(s,{label:"代理服务器：",prop:"proxyHost"},{default:a(()=>[e(A,{modelValue:n.value.proxyHost,"onUpdate:modelValue":l[11]||(l[11]=t=>n.value.proxyHost=t),filterable:"",clearable:"",placeholder:"请选择代理服务器",style:{width:"200px"}},{default:a(()=>[(V(!0),z(S,null,O(q.value,t=>(V(),G($,{key:t.label,value:t.value,label:t.label,disabled:t.disabled},null,8,["value","label","disabled"]))),128))]),_:1},8,["modelValue"])]),_:1}),e(s,{label:"代理端口：",prop:"proxyPort"},{default:a(()=>[e(u,{style:{width:"200px"},modelValue:n.value.proxyPort,"onUpdate:modelValue":l[12]||(l[12]=t=>n.value.proxyPort=t),clearable:""},null,8,["modelValue"])]),_:1}),e(s,{label:"用途：",prop:"description"},{default:a(()=>[e(u,{style:{width:"200px"},modelValue:n.value.description,"onUpdate:modelValue":l[13]||(l[13]=t=>n.value.description=t),clearable:""},null,8,["modelValue"])]),_:1}),e(s,null,{default:a(()=>[e(k,{type:"primary",onClick:l[14]||(l[14]=t=>ee(N.value)),style:{"margin-left":"50%"}},{default:a(()=>[y("提交 ")]),_:1})]),_:1})]),_:1},8,["model","rules"])]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)}}}),Ae=ge(Fe,[["__scopeId","data-v-7aa3ce25"]]);export{Ae as default};
