import{a as j}from"./projectApi-DNyIEPDE.js";import{a as $}from"./axios-CEz4Hwn_.js";import{s as oe}from"./sleeep-DLQXQLPT.js";import{d as se,j as y,s as ue,E as w,o as C,c as E,f as e,w as l,F as M,r as c,n as d,a as N,l as z,A as O,O as G,t as x,m as J}from"./index-B8KVQuq1.js";function Q(g){const s=new TextEncoder().encode(g);let p="";const _=s.byteLength;for(let v=0;v<_;v++)p+=String.fromCharCode(s[v]);return btoa(p)}function W(g){const o=atob(g),s=new Uint8Array(o.length);for(let _=0;_<o.length;_++)s[_]=o.charCodeAt(_);return new TextDecoder("utf-8").decode(s)}const A="/k8s";async function de(g){return(await $.post(`${A}/env`,g)).data}async function ie(g){return(await $.post(`${A}/server`,g)).data}async function pe(g){return(await $.delete(`${A}/env/${g}`)).data}async function ve(g){return(await $.delete(`${A}/server`,{data:g})).data}const fe=(g,o,s)=>{const p=/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;if(o)if(p.test(o))s();else return s(new Error("请输入正确的IPv4地址"));else return s(new Error("请输入ip"))},me=(g,o,s)=>{const p=Number(o);if(!o&&o!==0)return s(new Error("请输入端口"));if(isNaN(p)||p<1||p>65535||!Number.isInteger(p))return s(new Error("端口号必须在1到65535之间"));s()},ce={"serverInfo.ip":{required:!0,validator:fe,trigger:"change"},"serverInfo.port":{required:!0,validator:me,trigger:"change"},"serverInfo.userName":{required:!0,message:"请输入用户名",trigger:"change"},"serverInfo.password":{required:!0,message:"请输入密码",trigger:"change"}},ge={envName:{required:!0,message:"请输入环境标志",trigger:"change"},envDescription:{required:!0,message:"请输入环境名称",trigger:"change"},envType:{required:!0,message:"请选择环境类型",trigger:"change"}},_e={style:{"margin-left":"5%"}},ye=N("h3",null,"服务器信息:",-1),we={style:{"margin-right":"15px"}},be={style:{"margin-right":"15px"}},Ve={style:{"margin-right":"15px"}},Ie={style:{"margin-right":"15px"}},Ce=se({__name:"EnvManage",setup(g){const o=y(),s=y(!1),p=y(!1),_=y(!1),v=y({envName:"",envDescription:"",envType:"",serverSet:[]}),a=y({envName:"",serverInfo:{ip:"",port:22,userName:"root",password:""}}),H=y(ce),X=y(ge),I=y(),D=y();ue(k);const S=y(!1);async function Y(){S.value=!0,await oe(500);const n=await j();S.value=!1,n.success?(o.value=n.data,w.success("刷新成功")):w.error(n.msg)}async function k(){const n=await j();n.success?o.value=n.data:w.error(n.msg)}async function Z(n){n&&await n.validate(async(t,u)=>{if(t){const b=O.service({lock:!0,text:"Loading",background:"rgba(0, 0, 0, 0.7)"}),f=await de(v.value);b.close(),f.success?(await k(),D.value.resetFields(),s.value=!1,w.success("添加成功")):w.error(f.msg)}else console.log("error submit!",u)})}async function ee(n){n&&await n.validate(async(t,u)=>{var b;if(t){const f={ip:a.value.serverInfo.ip,port:a.value.serverInfo.port,userName:a.value.serverInfo.userName,password:Q(a.value.serverInfo.password)};(b=v.value.serverSet)==null||b.push(f),I.value.resetFields(),_.value=!1}else console.log("error submit!",u)})}async function le(n){n&&await n.validate(async(t,u)=>{if(t){const b={envName:a.value.envName,serverInfo:{ip:a.value.serverInfo.ip,port:a.value.serverInfo.port,userName:a.value.serverInfo.userName,password:Q(a.value.serverInfo.password)}},f=O.service({lock:!0,text:"Loading",background:"rgba(0, 0, 0, 0.7)"}),R=await ie(b);f.close(),R.success?(await k(),I.value.resetFields(),p.value=!1,w.success("添加成功")):w.error(R.msg)}else console.log("error submit!",u)})}function te(n){G.confirm("确认删除当前环境?",{confirmButtonText:"是",cancelButtonText:"取消",type:"warning"}).then(async()=>{const t=await pe(n);t.success?(await k(),w.success("删除成功")):w.error(t.msg)}).catch(()=>{})}function re(n,t,u){G.confirm("确认删除当前服务器?",{confirmButtonText:"是",cancelButtonText:"取消",type:"warning"}).then(async()=>{const b=O.service({lock:!0,text:"Loading",background:"rgba(0, 0, 0, 0.7)"}),f=await ve({envName:n,ip:t,port:u});b.close(),f.success?(await k(),w.success("删除成功")):w.error(f.msg)}).catch(()=>{})}return(n,t)=>{const u=c("el-button"),b=c("el-header"),f=c("el-descriptions-item"),R=c("el-descriptions"),h=c("el-table-column"),ae=c("el-table"),F=c("el-main"),U=c("el-container"),V=c("el-input"),m=c("el-form-item"),L=c("el-radio"),B=c("el-tooltip"),ne=c("el-radio-group"),T=c("el-form"),q=c("el-dialog");return C(),E(M,null,[e(U,null,{default:l(()=>[e(b,null,{default:l(()=>[e(u,{type:"primary",onClick:t[0]||(t[0]=r=>s.value=!0)},{default:l(()=>[d(" 添加新环境 ")]),_:1}),e(u,{icon:"refresh",onClick:Y,loading:S.value},null,8,["loading"])]),_:1}),e(F,null,{default:l(()=>[e(ae,{data:o.value,stripe:"","max-height":"600"},{default:l(()=>[e(h,{type:"expand"},{default:l(r=>[N("div",_e,[ye,(C(!0),E(M,null,z(r.row.serverSet,(i,K)=>(C(),E("div",{key:K},[e(R,{column:10},{default:l(()=>[e(f,{label:"IP",width:"180px"},{default:l(()=>[d(x(i.ip),1)]),_:2},1024),e(f,{label:"端口",width:"180px"},{default:l(()=>[d(x(i.port),1)]),_:2},1024),e(f,{label:"用户名",width:"180px"},{default:l(()=>[d(x(i.userName),1)]),_:2},1024),e(f,{width:"180px",label:"密码"},{default:l(()=>[d(x(J(W)(i.password)),1)]),_:2},1024),e(f,null,{default:l(()=>[e(u,{type:"danger",text:"",size:"small",onClick:P=>re(r.row.envName,i.ip,i.port)},{default:l(()=>[d(" 删除 ")]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)]))),128))])]),_:1}),e(h,{type:"index",label:"#"}),e(h,{prop:"envName",label:"环境标识",align:"center","header-align":"center"}),e(h,{prop:"envDescription",label:"环境名称",align:"center","header-align":"center"}),e(h,{prop:"envType",label:"环境类型",align:"center","header-align":"center"}),e(h,{label:"操作",align:"center","header-align":"center"},{default:l(r=>[e(u,{text:"",type:"danger",onClick:i=>te(r.row.envName)},{default:l(()=>[d("删除环境 ")]),_:2},1032,["onClick"]),d(" | "),e(u,{text:"",type:"primary",onClick:()=>{p.value=!0,a.value.envName=r.row.envName}},{default:l(()=>[d(" 添加服务 ")]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1})]),_:1}),e(q,{modelValue:s.value,"onUpdate:modelValue":t[6]||(t[6]=r=>s.value=r),title:"添加环境",width:"40%"},{default:l(()=>[e(T,null,{default:l(()=>[e(U,null,{default:l(()=>[e(F,null,{default:l(()=>[e(T,{model:v.value,"label-width":"100px",rules:X.value,ref_key:"envAddRuleFormRef",ref:D},{default:l(()=>[e(m,{label:"环境标识",prop:"envName"},{default:l(()=>[e(V,{modelValue:v.value.envName,"onUpdate:modelValue":t[1]||(t[1]=r=>v.value.envName=r),style:{width:"160px"}},null,8,["modelValue"])]),_:1}),e(m,{label:"环境名称",prop:"envDescription"},{default:l(()=>[e(V,{modelValue:v.value.envDescription,"onUpdate:modelValue":t[2]||(t[2]=r=>v.value.envDescription=r),style:{width:"160px"}},null,8,["modelValue"])]),_:1}),e(m,{label:"环境类型",prop:"envType"},{default:l(()=>[e(ne,{modelValue:v.value.envType,"onUpdate:modelValue":t[3]||(t[3]=r=>v.value.envType=r)},{default:l(()=>[e(B,{content:"Rebirth1.0，更新yaml就会自动拉取镜像，如新预发布环境"},{default:l(()=>[e(L,{value:"REBIRTH_V1"},{default:l(()=>[d("Rebirth1.0")]),_:1})]),_:1}),e(B,{content:"需要先使用docker pull拉下来镜像，如城轨环境"},{default:l(()=>[e(L,{value:"NEED_DOCKER_PULL"},{default:l(()=>[d("NEED_DOCKER_PULL")]),_:1})]),_:1}),e(B,{content:"Rebirth2.0 需要先在一个环境拉取镜像并SAVE，再传到部署环境LOAD镜像，且部署环境使用的是nerdctl而非docker，如开发环境"},{default:l(()=>[e(L,{value:"REBIRTH_V2"},{default:l(()=>[d("Rebirth2.0")]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}),e(m,{label:"服务器："},{default:l(()=>[N("div",null,[(C(!0),E(M,null,z(v.value.serverSet,(r,i)=>(C(),E("p",{key:i},[N("span",we,"IP："+x(r.ip),1),N("span",be,"端口："+x(r.port),1),N("span",Ve,"用户名："+x(r.userName),1),N("span",Ie,"密码："+x(J(W)(r.password)),1),e(u,{type:"danger",text:"",onClick:K=>{var P;return(P=v.value.serverSet)==null?void 0:P.splice(i,1)}},{default:l(()=>[d("删除")]),_:2},1032,["onClick"])]))),128))])]),_:1}),e(u,{type:"primary",style:{"margin-left":"5%"},onClick:t[4]||(t[4]=r=>_.value=!0)},{default:l(()=>[d("添加服务器")]),_:1}),e(m,null,{default:l(()=>[e(u,{type:"primary",style:{"margin-left":"85%"},onClick:t[5]||(t[5]=r=>Z(D.value))},{default:l(()=>[d("提交 ")]),_:1})]),_:1})]),_:1},8,["model","rules"])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(q,{modelValue:p.value,"onUpdate:modelValue":t[12]||(t[12]=r=>p.value=r),title:"添加服务",width:"20%",onClose:t[13]||(t[13]=r=>{var i;return(i=I.value)==null?void 0:i.resetFields()})},{default:l(()=>[e(U,null,{default:l(()=>[e(F,null,{default:l(()=>[e(T,{"label-width":"100px",model:a.value,rules:H.value,ref_key:"ruleFormRef",ref:I},{default:l(()=>[e(m,{label:"IP：",prop:"serverInfo.ip"},{default:l(()=>[e(V,{style:{width:"160px"},modelValue:a.value.serverInfo.ip,"onUpdate:modelValue":t[7]||(t[7]=r=>a.value.serverInfo.ip=r),clearable:""},null,8,["modelValue"])]),_:1}),e(m,{label:"端口：",prop:"serverInfo.port"},{default:l(()=>[e(V,{style:{width:"160px"},modelValue:a.value.serverInfo.port,"onUpdate:modelValue":t[8]||(t[8]=r=>a.value.serverInfo.port=r),clearable:""},null,8,["modelValue"])]),_:1}),e(m,{label:"用户名：",prop:"serverInfo.userName"},{default:l(()=>[e(V,{style:{width:"160px"},modelValue:a.value.serverInfo.userName,"onUpdate:modelValue":t[9]||(t[9]=r=>a.value.serverInfo.userName=r),clearable:""},null,8,["modelValue"])]),_:1}),e(m,{label:"密码：",prop:"serverInfo.password"},{default:l(()=>[e(V,{style:{width:"160px"},modelValue:a.value.serverInfo.password,"onUpdate:modelValue":t[10]||(t[10]=r=>a.value.serverInfo.password=r),clearable:""},null,8,["modelValue"])]),_:1}),e(m,null,{default:l(()=>[e(u,{type:"primary",onClick:t[11]||(t[11]=r=>le(I.value)),style:{"margin-left":"50%"}},{default:l(()=>[d("提交 ")]),_:1})]),_:1})]),_:1},8,["model","rules"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(q,{modelValue:_.value,"onUpdate:modelValue":t[19]||(t[19]=r=>_.value=r),title:"添加服务",width:"20%",onClose:t[20]||(t[20]=r=>{var i;return(i=I.value)==null?void 0:i.resetFields()})},{default:l(()=>[e(U,null,{default:l(()=>[e(F,null,{default:l(()=>[e(T,{"label-width":"100px",model:a.value,rules:H.value,ref_key:"ruleFormRef",ref:I},{default:l(()=>[e(m,{label:"IP：",prop:"serverInfo.ip"},{default:l(()=>[e(V,{style:{width:"160px"},modelValue:a.value.serverInfo.ip,"onUpdate:modelValue":t[14]||(t[14]=r=>a.value.serverInfo.ip=r),clearable:""},null,8,["modelValue"])]),_:1}),e(m,{label:"端口：",prop:"serverInfo.port"},{default:l(()=>[e(V,{style:{width:"160px"},modelValue:a.value.serverInfo.port,"onUpdate:modelValue":t[15]||(t[15]=r=>a.value.serverInfo.port=r),clearable:""},null,8,["modelValue"])]),_:1}),e(m,{label:"用户名：",prop:"serverInfo.userName"},{default:l(()=>[e(V,{style:{width:"160px"},modelValue:a.value.serverInfo.userName,"onUpdate:modelValue":t[16]||(t[16]=r=>a.value.serverInfo.userName=r),clearable:""},null,8,["modelValue"])]),_:1}),e(m,{label:"密码：",prop:"serverInfo.password"},{default:l(()=>[e(V,{style:{width:"160px"},modelValue:a.value.serverInfo.password,"onUpdate:modelValue":t[17]||(t[17]=r=>a.value.serverInfo.password=r),clearable:""},null,8,["modelValue"])]),_:1}),e(m,null,{default:l(()=>[e(u,{type:"primary",onClick:t[18]||(t[18]=r=>ee(I.value)),style:{"margin-left":"50%"}},{default:l(()=>[d("提交 ")]),_:1})]),_:1})]),_:1},8,["model","rules"])]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)}}});export{Ce as default};
